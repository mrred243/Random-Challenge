<html>
  <head>
    <title>File System</title>
    <style>
      body {
        background-color: #fff;
        color: #000;
        font-family: "Helvetica Neue", sans-serif;
        padding: 20px;
        box-sizing: border-box;
        font-size: 12px;
        line-height: 150%;
      }

      h1 {
        font-weight: 200;
        letter-spacing: 0.1em;
        font-size: 14px;
      }

      #FileBrowser {
        border: 1px solid #f0f0f0;
        padding: 10px;
      }

      ul {
        list-style-type: none;
        padding-left: 10px;
        overflow: hidden;
      }

      #myUL {
        margin: 0;
        padding: 0;
      }

      .caret {
        cursor: pointer;
        position: relative;
        user-select: none;
      }

      .caret::before {
        content: "\25B6";
        font-size: 8px;
        color: black;
        display: inline-block;
        margin-right: 8px;
      }

      .caret-down::before {
        transform: rotate(90deg);
      }

      .nested {
        display: none;
      }

      .subtitle {
        position: relative;
        font-weight: lighter;
        font-size: 10px;
        margin-left: 5px;
      }
      .folder {
        font-weight: bold;
      }
      .birthtime,
      .size {
        float: right;
        text-align: right;
      }
      .birthtime {
        width: 130px;
      }

      @media only screen and (max-width: 570px) {
        .birthtime {
          display: none;
        }
      }

      @media only screen and (max-width: 650px) {
        .size {
          display: none;
        }
      }
    </style>
  </head>
  <body>
    <h1>File System</h1>
    <div id="FileBrowser"></div>

    <script>
      const jsonUrl = "./filesystem.json";

      const getJson = (url) => {
        return new Promise((resolve, reject) => {
          let xhr = new XMLHttpRequest();
          xhr.open("GET", url);

          xhr.onload = function () {
            if (xhr.status === 200) {
              resolve(xhr.responseText);
            } else {
              reject({
                status: this.status,
                statusText: xhr.statusText,
              });
            }
          };
          xhr.onerror = function () {
            reject({
              status: this.status,
              statusText: xhr.statusText,
            });
          };

          xhr.send();
        });
      };

      const looping = (array) => {
        if (Array.isArray(array)) {
          let ul = document.createElement("ul");
          ul.classList.add("nested");

          array.forEach(async (item) => {
            if (!item) return null;
            let li = await document.createElement("li");

            if (item.type === "file") {
              li.append(
                nameElement(item.name),
                timeElement(item.birthtime, false),
                sizeElement(item.size)
              );
            } else if (item.type === "slink") {
              let slinkName = nameElement(item.name);
              slinkName.append(`-> ${item.links_to}`);
              li.append(slinkName, timeElement(item.birthtime));
            } else if (item.type === "folder") {
              let folderName = nameElement(item.name);
              folderName.classList.add("folder");

              if (item.children.length !== 0) {
                folderName.classList.add("caret");
                li.append(
                  folderName,
                  subtitleElement(item.children.length),
                  timeElement(item.birthtime)
                );
                renderChildListAndToggleActiveClasses(folderName, item);
              } else {
                li.append(folderName, timeElement(item.birthtime, false));
              }
            } else {
              li.append(
                nameElement(item.name),
                timeElement(item.birthtime, false)
              );
            }
            ul.appendChild(li);
          });
          return ul;
        }
      };

      const timeElement = (time, getDate = true) => {
        let span = document.createElement("span");
        span.classList.add("birthtime");

        if (getDate) {
          span.innerText = new Date(time).toLocaleDateString("en-GB");
          return span;
        } else {
          span.innerText = new Date(time).toLocaleTimeString("en-GB");
          return span;
        }
      };

      const sizeElement = (size) => {
        let span = document.createElement("span");
        span.classList.add("size");
        span.innerText = size;
        return span;
      };

      const subtitleElement = (subtitle) => {
        let span = document.createElement("span");
        span.innerText = `(${subtitle} items)`;
        span.classList.add("subtitle");
        return span;
      };

      const nameElement = (name) => {
        let span = document.createElement("span");
        span.innerText = name;
        span.classList.add("name");
        return span;
      };

      const renderChildListAndToggleActiveClasses = (el, input) => {
        el.addEventListener("click", async () => {
          if (el.parentElement.lastChild.nodeName !== "UL") {
            console.log(el.parentElement);
            await el.parentElement.append(looping(input.children));
          }
          el.classList.toggle("caret-down");
          el.parentElement.lastChild.classList.toggle("nested");
        });
      };

      window.onload = async () => {
        let data = null;

        await getJson(jsonUrl)
          .then((response) => (data = JSON.parse(response)))
          .catch((err) => {
            console.error("error", err.statusText);
          });
        console.log("data", data);

        if (data == null) return null;

        let myUl = document.createElement("ul");
        myUl.setAttribute("id", "myUL");
        let li = document.createElement("li");
        let myUlName = nameElement(data.name);
        myUlName.classList.add("folder", "caret");

        myUlName.append(data.path),
          li.append(
            myUlName,
            subtitleElement(data.children.length),
            timeElement(data.birthtime)
          );

        renderChildListAndToggleActiveClasses(myUlName, data);

        myUl.appendChild(li);

        document.getElementById("FileBrowser").appendChild(myUl);
      };
    </script>
  </body>
</html>
